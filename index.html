<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA / Android Meta Tags -->
    <meta name="theme-color" content="#0055a5">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Verbessertes Manifest fÃ¼r echten App-Look auf dem Pixel 9a -->
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22wE-Jugend%20Handball%22,%22short_name%22:%22wE-Tabelle%22,%22start_url%22:%22index.html%22,%22display%22:%22standalone%22,%22orientation%22:%22portrait%22,%22background_color%22:%22#0055a5%22,%22theme_color%22:%22#0055a5%22,%22icons%22:[{%22src%22:%22https://cdn-icons-png.flaticon.com/512/3209/3209109.png%22,%22sizes%22:%22512x512%22,%22type%22:%22image/png%22,%22purpose%22:%22any%20maskable%22}]}">

    <!-- Apple Web App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="wE-Tabelle">
    <title>wE-Jugend Live-Tabelle</title>
    
    <!-- App Icons -->
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3209/3209109.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3209/3209109.png">
    
    <style>
        :root {
            --hamburg-blue: #0055a5;
            --hamburg-red: #e11a2b;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-main: #333333;
            --text-muted: #666666;
            --safe-area-top: env(safe-area-inset-top);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            /* Optimierung fÃ¼r den App-Look (Safe Areas) */
            padding: calc(var(--safe-area-top) + 10px) 5px 20px 5px;
            display: flex;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: var(--card-bg);
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        h1 {
            text-align: center;
            color: var(--hamburg-blue);
            font-size: 1.1rem;
            margin: 5px 0 12px 0;
            text-transform: uppercase;
        }

        .btn-refresh {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 14px;
            background: var(--hamburg-blue);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 15px;
            -webkit-appearance: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-refresh:active {
            background: #004485;
            transform: scale(0.98);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        th {
            background: #f8f9fa;
            color: var(--text-muted);
            font-size: 0.65rem;
            text-transform: uppercase;
            padding: 10px 2px;
            border-bottom: 2px solid #eee;
        }

        td {
            padding: 14px 2px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }

        .team-cell {
            text-align: left;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }

        .logo {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .pts { font-weight: bold; color: var(--hamburg-blue); }
        .diff { font-style: italic; color: #666; font-size: 0.7rem; }
        .highlight { background-color: #eff6ff !important; }
        
        tr.clickable { cursor: pointer; }
        tr.clickable:active { background-color: #f0f0f0; }

        /* Detail View Layout */
        #detail-view { display: none; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .detail-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 0.9rem;
            font-weight: bold;
            margin: 20px 0 10px 0;
            color: var(--hamburg-blue);
            border-left: 4px solid var(--hamburg-blue);
            padding-left: 10px;
        }

        .game-card {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: grid;
            grid-template-columns: 70px 1fr 70px;
            align-items: center;
            font-size: 0.8rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.02);
        }

        .game-res { text-align: right; font-weight: bold; color: var(--hamburg-blue); white-space: nowrap; }
        .game-date { color: var(--text-muted); font-size: 0.7rem; }
        
        #status-msg { text-align: center; color: var(--text-muted); font-size: 0.7rem; margin-top: 20px; padding-bottom: 20px; }
        
        /* Android Install Prompt Overlay */
        #install-overlay {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 5%;
            width: 90%;
            background: #333;
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            font-size: 0.85rem;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="main-view">
        <h1>wE-Jugend KL 588 LIVE</h1>
        <button class="btn-refresh" onclick="fetchData()">ðŸ”„ Aktualisieren</button>
        <table>
            <thead>
                <tr>
                    <th>Pl.</th>
                    <th style="text-align:left;">Team</th>
                    <th>Sp.</th>
                    <th>S</th>
                    <th>U</th>
                    <th>N</th>
                    <th>Tore</th>
                    <th>Diff.</th>
                    <th>Pkt.</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

    <div id="detail-view">
        <div class="detail-header">
            <img id="detail-team-logo" class="logo" style="width:60px; height:60px;" src="">
            <h2 id="detail-team-name" style="margin:10px 0 0 0; font-size:1.2rem;"></h2>
        </div>
        <button class="btn-refresh" style="background:#6c757d;" onclick="showMainView()">â¬… ZurÃ¼ck zur Tabelle</button>
        
        <div class="section-title">Absolvierte Spiele</div>
        <div id="played-games"></div>
        
        <div class="section-title">Weiterer Spielplan</div>
        <div id="upcoming-games"></div>
    </div>
    
    <div id="status-msg">Lade Daten...</div>
</div>

<div id="install-overlay">
    <span>App zum Startbildschirm hinzufÃ¼gen?</span>
    <button onclick="this.parentElement.style.display='none'" style="background:var(--hamburg-blue); border:none; color:white; padding:8px 12px; border-radius:5px;">OK</button>
</div>

<script>
const SHEET_ID = '1rHPyr7IP8vaYsDIpWXjH3kp7I65lBwXLhhkNYYDByHE';
let allGames = [];
let teamStats = {};

function formatTime(cell) {
    if (!cell || cell.v === null) return "";
    if (cell.f) return cell.f;
    const val = cell.v;
    if (typeof val === 'string' && val.includes('Date')) {
        const p = val.match(/\d+/g);
        if (p && p.length >= 5) return p[3].padStart(2, '0') + ":" + p[4].padStart(2, '0');
    }
    if (typeof val === 'string' && val.includes(':')) {
        const parts = val.split(':');
        return parts[0].padStart(2, '0') + ":" + parts[1].padStart(2, '0');
    }
    return "";
}

window.handleResponse = function(response) {
    const rows = response.table.rows;
    allGames = rows;
    teamStats = {};

    rows.forEach((row) => {
        const c = row.c;
        if (!c || !c[2] || !c[3]) return;
        const home = c[2].v ? c[2].v.toString().trim() : "";
        const guest = c[3].v ? c[3].v.toString().trim() : "";
        if (home === "Heim" || home === "") return;

        [ {n: home, l: c[8]?.v}, {n: guest, l: c[9]?.v} ].forEach(t => {
            if (!teamStats[t.n]) teamStats[t.n] = { name: t.n, logo: t.l, sp:0, s:0, u:0, n:0, tp:0, tg:0, plus:0, minus:0 };
        });

        const resH = (c[4] && c[4].v !== null && !isNaN(parseFloat(c[4].v))) ? parseFloat(c[4].v) : null;
        const resG = (c[5] && c[5].v !== null && !isNaN(parseFloat(c[5].v))) ? parseFloat(c[5].v) : null;
        const isWertung = (c[6] && (c[6].v === true || c[6].v === "TRUE" || c[6].v === "true"));
        const winnerName = (c[7] && c[7].v) ? c[7].v.toString().trim() : null;

        if (isWertung || (resH !== null && resG !== null)) {
            teamStats[home].sp++; teamStats[guest].sp++;
            const gH = resH || 0; const gG = resG || 0;
            teamStats[home].tp += gH; teamStats[home].tg += gG;
            teamStats[guest].tp += gG; teamStats[guest].tg += gH;
            
            let w = "";
            if (isWertung) w = winnerName;
            else if (resH > resG) w = home;
            else if (resG > resH) w = guest;

            if (w === home) {
                teamStats[home].s++; teamStats[home].plus += 2;
                teamStats[guest].n++; teamStats[guest].minus += 2;
            } else if (w === guest) {
                teamStats[guest].s++; teamStats[guest].plus += 2;
                teamStats[home].n++; teamStats[home].minus += 2;
            } else if (!isWertung && resH === resG) {
                teamStats[home].u++; teamStats[home].plus += 1; teamStats[home].minus += 1;
                teamStats[guest].u++; teamStats[guest].plus += 1; teamStats[guest].minus += 1;
            }
        }
    });
    renderTable();
    document.getElementById('status-msg').innerText = "Stand: " + new Date().toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'}) + " Uhr";
};

function renderTable() {
    const sorted = Object.values(teamStats).sort((a,b) => (b.plus - a.plus) || (a.minus - b.minus) || ((b.tp-b.tg) - (a.tp-a.tg)) || (b.tp - a.tp));
    const tbody = document.getElementById('table-body');
    tbody.innerHTML = '';
    
    sorted.forEach((t, i) => {
        const row = document.createElement('tr');
        row.className = 'clickable' + (t.name.toLowerCase().includes("deerns") ? ' highlight' : '');
        row.onclick = () => showDetails(t.name);
        const diff = t.tp - t.tg;
        row.innerHTML = `
            <td>${i+1}</td>
            <td><div class="team-cell"><img class="logo" src="${t.logo ? 'https://www.handball.net/files/clubs/logos/'+t.logo : 'https://www.handball.net/img/default-club-logo.png'}"><span>${t.name}</span></div></td>
            <td>${t.sp}</td><td>${t.s}</td><td>${t.u}</td><td>${t.n}</td>
            <td>${t.tp}:${t.tg}</td><td class="diff">${diff > 0 ? '+' : ''}${diff}</td>
            <td class="pts">${t.plus}:${t.minus}</td>`;
        tbody.appendChild(row);
    });
}

function showDetails(teamName) {
    window.scrollTo(0,0);
    document.getElementById('main-view').style.display = 'none';
    document.getElementById('detail-view').style.display = 'block';
    document.getElementById('detail-team-name').innerText = teamName;
    const team = teamStats[teamName];
    document.getElementById('detail-team-logo').src = team.logo ? `https://www.handball.net/files/clubs/logos/${team.logo}` : "https://www.handball.net/img/default-club-logo.png";
    
    const playedDiv = document.getElementById('played-games');
    const upcomingDiv = document.getElementById('upcoming-games');
    playedDiv.innerHTML = ''; upcomingDiv.innerHTML = '';

    const teamGames = [];
    allGames.forEach((row) => {
        const c = row.c;
        if (!c || !c[2] || !c[3]) return;
        const h = c[2].v?.toString().trim();
        const g = c[3].v?.toString().trim();
        if ((h === teamName || g === teamName) && h !== "Heim") {
            teamGames.push(row);
        }
    });

    teamGames.forEach((row) => {
        const c = row.c;
        const h = c[2].v?.toString().trim();
        const g = c[3].v?.toString().trim();
        const date = c[0]?.f || c[0]?.v || "?";
        const formattedTime = formatTime(c[1]);
        
        const resH = (c[4] && c[4].v !== null && !isNaN(parseFloat(c[4].v))) ? parseFloat(c[4].v) : null;
        const resG = (c[5] && c[5].v !== null && !isNaN(parseFloat(c[5].v))) ? parseFloat(c[5].v) : null;
        const isPlayed = (resH !== null || (c[6] && (c[6].v === true || c[6].v === "TRUE" || c[6].v === "true")));
        const displayScore = isPlayed ? `${resH}:${resG}` : (formattedTime ? formattedTime + ' Uhr' : 'TBD');

        const html = `
            <div class="game-card">
                <div class="game-date">${date.split('.')[0]}.${date.split('.')[1]}.</div>
                <div class="game-teams"><b>${h}</b><br>${g}</div>
                <div class="game-res">${displayScore}</div>
            </div>`;
        
        if (isPlayed) playedDiv.innerHTML += html;
        else upcomingDiv.innerHTML += html;
    });
}

function showMainView() {
    document.getElementById('detail-view').style.display = 'none';
    document.getElementById('main-view').style.display = 'block';
}

function fetchData() {
    const script = document.createElement('script');
    script.src = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=responseHandler:handleResponse&range=A1:J100`;
    document.body.appendChild(script);
}

// PWA Install Prompt Logic
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    document.getElementById('install-overlay').style.display = 'flex';
});

fetchData();
</script>
</body>
</html>
