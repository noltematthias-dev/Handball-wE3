<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Einstellungen -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0055a5">
    
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22wE-Jugend%20Handball%20Live%22,%22short_name%22:%22wE-Handball%22,%22start_url%22:%22index.html%22,%22display%22:%22standalone%22,%22orientation%22:%22portrait%22,%22background_color%22:%22#f0f2f5%22,%22theme_color%22:%22#0055a5%22,%22icons%22:[{%22src%22:%22https://cdn-icons-png.flaticon.com/512/3209/3209109.png%22,%22sizes%22:%22512x512%22,%22type%22:%22image/png%22,%22purpose%22:%22any%20maskable%22}]}">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3209/3209109.png">

    <title>wE-Jugend Live-Tabelle</title>
    
    <style>
        :root {
            --hamburg-blue: #0055a5;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-main: #1d1b20;
            --text-muted: #49454f;
            --safe-top: env(safe-area-inset-top, 0px);
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
            font-family: 'Roboto', 'Segoe UI', -apple-system, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            padding-top: var(--safe-top);
        }

        body.modal-open { overflow: hidden; }

        #app-content {
            transition: filter 0.3s ease;
            padding: 16px 12px 24px 12px;
        }

        .blurred { filter: blur(10px) brightness(0.9); pointer-events: none; }

        header { text-align: center; margin-bottom: 24px; }
        h1 { color: var(--hamburg-blue); font-size: 1.4rem; margin: 12px 0; font-weight: 700; }

        .nav-tabs {
            display: flex;
            background: #e6e0e9;
            border-radius: 25px;
            padding: 4px;
            margin: 0 auto;
            max-width: 320px;
            border: 1px solid #79747e;
        }

        .tab {
            flex: 1; padding: 10px; border: none; background: none; border-radius: 21px;
            font-weight: 600; font-size: 0.9rem; color: var(--text-muted); transition: all 0.2s;
        }

        .tab.active { background: var(--hamburg-blue); color: white; }

        .card { 
            background: var(--card-bg); 
            border-radius: 24px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            padding: 16px 8px; 
            margin-bottom: 16px; 
        }

        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th { color: var(--text-muted); font-size: 0.7rem; padding: 12px 4px; border-bottom: 1px solid #cac4d0; text-transform: uppercase; }
        td { padding: 14px 4px; text-align: center; border-bottom: 1px solid #eee; }
        
        .team-cell { text-align: left; display: flex; align-items: center; gap: 8px; font-weight: 600; }
        .logo { width: 24px; height: 24px; object-fit: contain; }
        
        .pts { font-weight: 900; color: var(--hamburg-blue); }
        
        .highlight { background-color: transparent; border-left: none; }

        .game-list { display: flex; flex-direction: column; gap: 12px; }
        .game-item {
            background: #fff; padding: 16px; border-radius: 20px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
            display: flex; flex-direction: column; gap: 8px;
            border: 1px solid #f0f0f0;
        }
        
        .game-main {
            display: grid;
            grid-template-columns: 1fr 80px 1fr;
            align-items: center;
            gap: 8px;
        }

        .game-team { font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; }
        .game-team.right { justify-content: flex-end; text-align: right; }
        
        .game-score { 
            background: #e8def8; color: #21005d; padding: 6px 4px; 
            border-radius: 12px; font-weight: 800; text-align: center; font-size: 0.85rem;
            min-height: 32px; display: flex; align-items: center; justify-content: center;
        }
        
        .game-info { font-size: 0.7rem; color: var(--text-muted); text-align: center; padding-top: 6px; border-top: 1px dashed #ddd; }

        .scorer-trigger-container { 
            display: none; 
            justify-content: center;
            margin: 24px 0;
            width: 100%;
        }
        
        #btn-scorers-small {
            width: 48px; height: 48px; background: #d3e3fd; color: #041e49;
            border-radius: 14px; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15); border: none; cursor: pointer;
        }

        @keyframes rotateBall { 0% { transform: rotate(0deg); } 100% { transform: rotate(720deg); } }
        #btn-scorers-small.loading .icon-ball { animation: rotateBall 1.5s infinite linear; }
        .icon-ball { width: 28px; height: 28px; fill: currentColor; }

        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.32); display: none; justify-content: center; align-items: flex-end; 
            z-index: 2000; opacity: 0; transition: opacity 0.3s ease;
        }

        #modal-window {
            background: #fff; width: 100%; max-width: 600px; max-height: 90vh;
            border-radius: 28px 28px 0 0; padding: 24px; overflow-y: auto;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.05, 0.7, 0.1, 1);
            box-shadow: 0 -8px 32px rgba(0,0,0,0.12);
        }

        #modal-overlay.active { display: flex; opacity: 1; }
        #modal-window.open { transform: translateY(0); }

        .close-bar { width: 32px; height: 4px; background: #79747e; border-radius: 2px; margin: -8px auto 24px auto; opacity: 0.4; }

        .scorer-card {
            display: grid; grid-template-columns: 48px 1fr 48px;
            align-items: center; gap: 16px; padding: 16px 4px; border-bottom: 1px solid #eee;
        }
        .scorer-name { font-weight: 700; font-size: 1rem; }
        .scorer-count { background: #d3e3fd; color: #041e49; font-weight: 900; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 12px; }
    </style>
</head>
<body>

<div id="app-content">
    <header>
        <h1>wE-Jugend Handball</h1>
        <div class="nav-tabs">
            <button id="btn-tab-table" class="tab active" onclick="switchTab('table')">Tabelle</button>
            <button id="btn-tab-schedule" class="tab" onclick="switchTab('schedule')">Spielplan</button>
        </div>
    </header>

    <div id="view-table">
        <div class="card">
            <table>
                <colgroup><col style="width: 30px;"><col><col style="width: 30px;"><col style="width: 70px;"><col style="width: 40px;"><col style="width: 50px;"></colgroup>
                <thead><tr><th>#</th><th style="text-align:left;">Team</th><th>S</th><th>Tore</th><th>+/-</th><th>Pkt.</th></tr></thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="view-schedule" style="display:none;">
        <div id="full-schedule-list" class="game-list"></div>
    </div>

    <div id="scorer-btn-wrapper" class="scorer-trigger-container">
        <button id="btn-scorers-small" onclick="handleScorerClick()">
            <svg class="icon-ball" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4C13.11,4 14.12,4.36 14.94,4.96L12,10.1L9.06,4.96C9.88,4.36 10.89,4 12,4M5.61,6.5C6.39,5.7 7.37,5.13 8.44,4.82L10.85,9.03L5.6,10.05C5.47,8.83 5.47,7.63 5.61,6.5M4,12C4,11.33 4.09,10.68 4.25,10.06L9.5,9.04L9.5,14.96L4.25,13.94C4.09,13.32 4,12.67 4,12M5.61,17.5C5.47,16.37 5.47,15.17 5.6,13.95L10.85,14.97L8.44,19.18C7.37,18.87 6.39,18.3 5.61,17.5M12,20C10.89,20 9.88,19.64 9.06,19.04L12,13.9L14.94,19.04C14.12,19.64 13.11,20 12,20M18.39,17.5C17.61,18.3 16.63,18.87 15.56,19.18L13.15,14.97L18.4,13.95C18.53,15.17 18.53,16.37 18.39,17.5M20,12C20,12.67 19.91,13.32 19.75,13.94L14.5,14.96L14.5,9.04L19.75,10.06C19.91,10.68 20,11.33 20,12M18.39,6.5C18.53,7.63 18.53,8.83 18.4,10.05L13.15,9.03L15.56,4.82C16.63,5.13 17.61,5.7 18.39,6.5Z" /></svg>
        </button>
    </div>
</div>

<div id="modal-overlay" onclick="closeDetails()">
    <div id="modal-window" onclick="event.stopPropagation()">
        <div class="close-bar"></div>
        <div class="modal-header">
            <img id="modal-logo" src="" class="logo" style="width:48px; height:48px;">
            <h2 id="modal-title" style="margin:0; font-size:1.2rem;"></h2>
        </div>
        <div id="modal-content"></div>
    </div>
</div>

<script>
const SHEET_ID = '1rHPyr7IP8vaYsDIpWXjH3kp7I65lBwXLhhkNYYDByHE';
let allGames = [], teamStats = {}, scorers = [], teamLogos = {};

function getLogoUrl(id) { return id ? `https://www.handball.net/files/clubs/logos/${id}` : "https://www.handball.net/img/default-club-logo.png"; }

window.handleResponse = function(r) {
    if(!r || !r.table) return;
    allGames = r.table.rows; teamStats = {};
    allGames.forEach(row => {
        const c = row.c; 
        if(!c || !c[2] || !c[3] || (c[2].v && c[2].v === "Heim")) return;
        const h = c[2].v, g = c[3].v;
        if(!h || !g) return; 
        
        teamLogos[h] = {id: c[8]?.v}; teamLogos[g] = {id: c[9]?.v};
        [h, g].forEach(n => { if(!teamStats[n]) teamStats[n] = {name:n, logo:teamLogos[n].id, sp:0, tp:0, tg:0, plus:0, minus:0}; });
        
        const rH = c[4]?.v, rG = c[5]?.v;
        if(rH !== null && rG !== null && rH !== undefined && rG !== undefined) {
            teamStats[h].sp++; teamStats[g].sp++;
            teamStats[h].tp += rH; teamStats[h].tg += rG;
            teamStats[g].tp += rG; teamStats[g].tg += rH;
            if(rH > rG) { teamStats[h].plus += 2; teamStats[g].minus += 2; }
            else if(rG > rH) { teamStats[g].plus += 2; teamStats[h].minus += 2; }
            else { teamStats[h].plus++; teamStats[h].minus++; teamStats[g].plus++; teamStats[g].minus++; }
        }
    });
    renderTable();
};

window.handleScorerResponse = function(r) {
    if(!r || !r.table) return;
    scorers = r.table.rows.slice(1).map(row => ({ 
        name: row.c[0]?.v, 
        team: row.c[1]?.v, 
        goals: row.c[2]?.v 
    })).filter(s => s.goals > 0 && s.name);
};

function renderTable() {
    const sorted = Object.values(teamStats).sort((a,b) => (b.plus - a.plus) || ((b.tp-b.tg) - (a.tp-a.tg)));
    const tbody = document.getElementById('table-body');
    tbody.innerHTML = '';
    sorted.forEach((t, i) => {
        const row = document.createElement('tr');
        if(t.name.toLowerCase().includes("deerns")) row.classList.add('highlight');
        row.onclick = () => showTeamDetails(t.name);
        row.innerHTML = `<td>${i+1}</td><td><div class="team-cell"><img class="logo" src="${getLogoUrl(t.logo)}"><span>${t.name}</span></div></td><td>${t.sp}</td><td style="font-variant-numeric: tabular-nums;">${t.tp}:${t.tg}</td><td style="color:#777">${t.tp-t.tg}</td><td class="pts">${t.plus}:${t.minus}</td>`;
        tbody.appendChild(row);
    });
}

function handleScorerClick() {
    const btn = document.getElementById('btn-scorers-small');
    btn.classList.add('loading');
    fetchData();
    setTimeout(() => { btn.classList.remove('loading'); showScorers(); }, 1000);
}

function showTeamDetails(name) {
    const t = teamStats[name];
    if(!t) return;
    document.getElementById('modal-title').innerText = name;
    document.getElementById('modal-logo').src = getLogoUrl(t.logo);
    document.getElementById('modal-logo').style.display = 'block';
    const content = document.getElementById('modal-content');
    content.innerHTML = '<div class="game-list"></div>';
    const list = content.querySelector('.game-list');
    allGames.forEach(row => {
        if(row.c && (row.c[2]?.v === name || row.c[3]?.v === name)) {
            const div = document.createElement('div');
            div.className = 'game-item';
            const h = row.c[2]?.v || "", g = row.c[3]?.v || "";
            const uhrzeit = row.c[1]?.f || row.c[1]?.v || "--:--";
            const datum = row.c[0]?.f || row.c[0]?.v || "";
            const res = (row.c[4]?.v !== null && row.c[4]?.v !== undefined) ? `${row.c[4].v}:${row.c[5].v}` : uhrzeit;
            div.innerHTML = `<div class="game-main"><div class="game-team"><img src="${getLogoUrl(row.c[8]?.v)}" class="logo"><span>${h}</span></div><div class="game-score">${res}</div><div class="game-team right"><span>${g}</span><img src="${getLogoUrl(row.c[9]?.v)}" class="logo"></div></div><div class="game-info">${datum}</div>`;
            list.appendChild(div);
        }
    });
    openModal();
}

function showScorers() {
    document.getElementById('modal-title').innerText = "Torschützen";
    document.getElementById('modal-logo').style.display = 'none';
    const list = document.getElementById('modal-content');
    list.innerHTML = '';
    scorers.sort((a,b) => b.goals - a.goals).forEach(s => {
        const div = document.createElement('div');
        div.className = 'scorer-card';
        div.innerHTML = `<img class="logo" src="${getLogoUrl(teamLogos[s.team]?.id)}"><div><div class="scorer-name">${s.name}</div><div class="scorer-team">${s.team}</div></div><div class="scorer-count">${s.goals}</div>`;
        list.appendChild(div);
    });
    openModal();
}

function openModal() {
    document.getElementById('modal-overlay').classList.add('active');
    document.getElementById('app-content').classList.add('blurred');
    document.body.classList.add('modal-open');
    setTimeout(() => document.getElementById('modal-window').classList.add('open'), 10);
}

function closeDetails() {
    document.getElementById('modal-window').classList.remove('open');
    document.getElementById('app-content').classList.remove('blurred');
    document.body.classList.remove('modal-open');
    setTimeout(() => { document.getElementById('modal-overlay').classList.remove('active'); }, 300);
}

function switchTab(t) {
    document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
    document.getElementById('btn-tab-'+t).classList.add('active');
    document.getElementById('view-table').style.display = t === 'table' ? 'block' : 'none';
    document.getElementById('view-schedule').style.display = t === 'schedule' ? 'block' : 'none';
    
    const btnWrapper = document.getElementById('scorer-btn-wrapper');
    btnWrapper.style.display = t === 'schedule' ? 'flex' : 'none';

    if(t === 'schedule') {
        const list = document.getElementById('full-schedule-list');
        list.innerHTML = '';
        allGames.forEach(row => { 
            if(row.c && row.c[2] && row.c[2].v && row.c[2].v !== "Heim") {
                const div = document.createElement('div');
                div.className = 'game-item';
                const hName = row.c[2].v;
                const gName = row.c[3]?.v || "";
                const uhrzeit = row.c[1]?.f || row.c[1]?.v || "--:--";
                const datum = row.c[0]?.f || row.c[0]?.v || "";
                const scoreDisplay = (row.c[4]?.v !== null && row.c[4]?.v !== undefined) ? row.c[4].v+':'+row.c[5].v : uhrzeit;
                
                div.innerHTML = `<div class="game-main"><div class="game-team" onclick="showTeamDetails('${hName}')"><img src="${getLogoUrl(row.c[8]?.v)}" class="logo"><span>${hName}</span></div><div class="game-score">${scoreDisplay}</div><div class="game-team right" onclick="showTeamDetails('${gName}')"><span>${gName}</span><img src="${getLogoUrl(row.c[9]?.v)}" class="logo"></div></div><div class="game-info">${datum}</div>`;
                list.appendChild(div);
            }
        });
    }
}

function fetchData() {
    const s1 = document.createElement('script'); s1.src = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=responseHandler:handleResponse&range=A1:J150&gid=0`; document.body.appendChild(s1);
    const s2 = document.createElement('script'); s2.src = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=responseHandler:handleScorerResponse&sheet=${encodeURIComponent("Torschützenliste")}&range=A1:C100`; document.body.appendChild(s2);
}

let startY = 0;
document.getElementById('modal-window').addEventListener('touchstart', (e) => startY = e.touches[0].clientY);
document.getElementById('modal-window').addEventListener('touchmove', (e) => {
    let diff = e.touches[0].clientY - startY;
    if (diff > 0) {
        document.getElementById('modal-window').style.transform = `translateY(${diff}px)`;
        if (diff > 160) closeDetails();
    }
});
document.getElementById('modal-window').addEventListener('touchend', () => {
    document.getElementById('modal-window').style.transform = '';
});

window.onload = fetchData;
</script>
</body>
</html>
